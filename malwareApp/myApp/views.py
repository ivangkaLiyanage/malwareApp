from django.shortcuts import render, redirect
from django.core.files.storage import FileSystemStorage
from django.http import HttpResponse
from django.urls import reverse
#import uplod file database
from .models import UploadedMalwareFile
#pdf
import pdfkit
from django.template.loader import get_template
#alert 
from django.contrib import messages

#pdf download
config = pdfkit.configuration(wkhtmltopdf='/usr/local/bin/wkhtmltopdf')

def home(request):
    # Add any logic for the home page here
    return render(request, 'home.html')


def analyze(request):
    # Add any logic for the home page here
    return render(request, 'analyze.html')

#downloading result pdf
def generate_pdf(request, id):
    malware = UploadedMalwareFile.objects.filter(id=id)

    pdf = pdfkit.from_url(request.build_absolute_uri(reverse('results', args=[malware])), False, configuration=config)
    response = HttpResponse(pdf, content_type= 'application/pdf')
    response['Content-Disposition'] = 'attachment; filename="report.pdf"'

    return response


#for upload file
def upload_file(request):
    if request.method == 'POST':
        #takes the data of the input field with the name=malware
        malware_file = request.FILES.get('malware')
        if malware_file:
            file_name = malware_file.name
            file_size = malware_file.size
            new_file = UploadedMalwareFile(file=malware_file, file_name=file_name, file_size=file_size)
            new_file.save()
            messages.success(request, 'File is uploaded successfully')
            return redirect('results', id=new_file.id)
        messages.error(request, 'File is uploaded successfully')
    return render(request, 'analyze.html')

def results(request, id):
    malware = UploadedMalwareFile.objects.filter(id=id)
    
    return render(request, 'result.html', {'data': malware})
