from django.shortcuts import render, redirect
from django.core.files.storage import FileSystemStorage
from django.http import HttpResponse
from django.urls import reverse
#import uplod file database
from .models import UploadedMalwareFile
#pdf
import pdfkit
from django.template.loader import get_template
#alert 
from django.contrib import messages

#pdf download
config = pdfkit.configuration(wkhtmltopdf='/usr/local/bin/wkhtmltopdf')

def home(request):
    # Add any logic for the home page here
    return render(request, 'home.html')


def analyze(request):
    # Add any logic for the home page here
    return render(request, 'analyze.html')

#downloading result pdf
def generate_pdf(request, id):
    pdf = pdfkit.from_url(request.build_absolute_uri(reverse('template_pdf', args=[id])), False, configuration=config)
    response = HttpResponse(pdf, content_type= 'application/pdf')
    response['Content-Disposition'] = 'attachment; filename="report.pdf"'

    return response


#for upload file
def upload_file(request):
    if request.method == 'POST':
        #takes the data of the input field with the name=malware
        malware_file = request.FILES.get('malware')
        if malware_file:
            file_name = malware_file.name
            file_size = malware_file.size

            user_ip = request.META.get('REMOTE_ADDR')
            user_agent = request.META.get('HTTP_USER_AGENT')
            http_referer = request.META.get('HTTP_REFERER')
            http_host = request.META.get('HTTP_HOST')
            server_name = request.META.get('SERVER_NAME')
            server_port = request.META.get('SERVER_PORT')
            auth_type = request.META.get('AUTH_TYPE')
            request_method = request.META.get('REQUEST_METHOD')
            http_accept_language = request.META.get('HTTP_ACCEPT_LANGUAGE')
            query_string = request.META.get('QUERY_STRING')            

            new_file = UploadedMalwareFile(
                file=malware_file, 
                file_name=file_name, 
                file_size=file_size,
                user_ip = user_ip,
                user_agent = user_agent,
                http_referer = http_referer,
                http_host = http_host,
                server_name = server_name,
                server_port = server_port,
                auth_type = auth_type,
                request_method = request_method,
                http_accept_language = http_accept_language,
                query_string = query_string
            )

            new_file.save()
            messages.success(request, 'File is uploaded successfully')
            return redirect('results', id=new_file.id)
        messages.error(request, 'File is uploaded successfully')
    return render(request, 'analyze.html')

#the logic is created over here
def results(request, id):
    malware = UploadedMalwareFile.objects.filter(id=id)
    
    return render(request, 'result.html', {'data': malware})

def template_pdf(request, id):
    malware = UploadedMalwareFile.objects.filter(id=id)
    
    return render(request, 'download-template.html', {'data': malware})